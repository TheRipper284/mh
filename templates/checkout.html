{% extends "layout.html" %}
{% block content %}
<div class="row">
    <div class="col-lg-8">
        <h2 class="text-white mb-4">Resumen del Pedido - Mesa {{ mesa_num }}</h2>
        
        <div class="card bg-dark text-white mb-4">
            <div class="card-body">
                <h5 class="card-title mb-3">Items del Pedido</h5>
                <div class="table-responsive">
                    <table class="table table-dark table-sm">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Tamaño</th>
                                <th>Cantidad</th>
                                <th>Precio Unit.</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in cart_items %}
                            <tr>
                                <td>
                                    <strong>{{ item.name }}</strong>
                                    {% if item.division and item.second_half_name %}
                                    <br><small class="text-muted">Pizza dividida: {{ item.name.split(' / ')[0] }} / {{ item.second_half_name }}</small>
                                    {% elif item.category_name %}
                                    <br><small class="text-muted">{{ item.category_name }}</small>
                                    {% endif %}
                                    {% if item.division or item.orilla_queso %}
                                    <br>
                                    <small class="text-info">
                                        {% if item.division %}<span class="badge bg-warning text-dark">División (+$10)</span>{% endif %}
                                        {% if item.orilla_queso %}<span class="badge bg-success">Orilla de queso (+${{ "%.2f"|format(item.orilla_queso_price) }})</span>{% endif %}
                                    </small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.size %}
                                    <span class="badge bg-info">{{ item.size|title }}</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ item.quantity }}</td>
                                <td>${{ "%.2f"|format(item.price) }}</td>
                                <td><strong>${{ "%.2f"|format(item.subtotal) }}</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-primary">
                                <td colspan="4" class="text-end"><strong>TOTAL:</strong></td>
                                <td><strong class="fs-4">${{ "%.2f"|format(total) }}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card bg-dark text-white">
            <div class="card-body">
                <h5 class="card-title mb-3">Confirmar Pedido</h5>
                <p class="text-muted">Mesa: <strong class="text-white">{{ mesa_num }}</strong></p>
                <p class="text-muted">Total: <strong class="text-white fs-4">${{ "%.2f"|format(total) }}</strong></p>
                
                <div class="d-grid gap-2 mt-4">
                    <button id="submitOrderBtn" class="btn btn-success btn-lg">
                        Enviar Pedido a Cocina
                    </button>
                    <a href="{{ url_for('view_cart') }}" class="btn btn-outline-light">
                        Volver al Carrito
                    </a>
                </div>
                
                <div id="loadingSpinner" class="text-center mt-3" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Enviando...</span>
                    </div>
                    <p class="mt-2">Enviando pedido...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('submitOrderBtn').addEventListener('click', function() {
    const btn = this;
    const spinner = document.getElementById('loadingSpinner');
    
    btn.disabled = true;
    spinner.style.display = 'block';
    
    fetch('{{ url_for("submit_order") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = '{{ url_for("order_confirmation") }}';
        } else {
            alert('Error: ' + data.message);
            btn.disabled = false;
            spinner.style.display = 'none';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al enviar el pedido. Por favor, intenta de nuevo.');
        btn.disabled = false;
        spinner.style.display = 'none';
    });
});
</script>
{% endblock %}

