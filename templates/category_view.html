{% extends "layout.html" %}
{% block content %}

<div class="category-nav d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
    <h2 class="text-white mb-0">{{ category.name }}</h2>

    <div class="dropdown ms-md-auto">
        <button class="btn btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            Ir a otra categoría
        </button>
        <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end">
            <li><a class="dropdown-item" href="{{ url_for('index') }}">Inicio</a></li>
            <li><hr class="dropdown-divider"></li>
            {% for other in other_categories | default([]) %}
            <li>
                <a class="dropdown-item" href="{{ url_for('show_category', id=other._id|string) }}">
                    {{ other.name }}
                </a>
            </li>
            {% else %}
            <li><span class="dropdown-item-text text-muted">Sin otras categorías</span></li>
            {% endfor %}
        </ul>
    </div>
</div>

<div class="row g-3">
    {% for p in products %}
    <div class="col-4 col-md-4 col-lg-3">
        <div class="zoom-card-container">
            <div class="zoom-card card card-category text-white h-100" onclick="this.classList.toggle('zoomed')">
                <!-- Contenido principal (siempre visible) -->
                <div class="zoom-card-front">
                    <div class="card-img-wrap">
                        {% if p.image %}
                        <img src="{{ p.image }}" class="card-img-top" alt="{{ p.name }}">
                        {% else %}
                        <img src="{{ url_for('static', filename='uploads/default.jpg') }}" class="card-img-top" alt="{{ p.name }}">
                        {% endif %}
                    </div>
                    <div class="card-img-overlay d-flex flex-column justify-content-end p-3 overlay-dark">
                        <h5 class="card-title text-white mb-0">{{ p.name }}</h5>
                    </div>
                </div>
                
                <!-- Contenido expandido (se muestra al ampliar) -->
                <div class="zoom-card-back">
                    <h5 class="card-title text-center mb-3">{{ p.name }}</h5>
                    
                    {% if category.name.upper() == "PIZZAS" %}
                    <!-- PIZZAS: Precios por tamaño e ingredientes -->
                    <div class="mb-3">
                        <h6 class="text-neon text-center mb-2">Precios por Tamaño:</h6>
                        <ul class="list-unstyled small">
                            {% if p.price_individual %}
                            <li class="mb-1">Individual: <strong class="text-neon">${{ p.price_individual }}</strong></li>
                            {% endif %}
                            {% if p.price_chica %}
                            <li class="mb-1">Chica: <strong class="text-neon">${{ p.price_chica }}</strong></li>
                            {% endif %}
                            {% if p.price_mediana %}
                            <li class="mb-1">Mediana: <strong class="text-neon">${{ p.price_mediana }}</strong></li>
                            {% endif %}
                            {% if p.price_grande %}
                            <li class="mb-1">Grande: <strong class="text-neon">${{ p.price_grande }}</strong></li>
                            {% endif %}
                            {% if p.price_h4 %}
                            <li class="mb-1">H4: <strong class="text-neon">${{ p.price_h4 }}</strong></li>
                            {% endif %}
                        </ul>
                    </div>
                    {% if p.ingredients %}
                    <div class="mb-2">
                        <h6 class="text-neon text-center mb-1">Ingredientes:</h6>
                        <p class="small mb-0 text-center">{{ p.ingredients }}</p>
                    </div>
                    {% endif %}

                    {% elif category.name.upper() == "BEBIDAS" %}
                    <!-- BEBIDAS: Precio y ML -->
                    <div class="mb-3 text-center">
                        <h6 class="text-neon mb-2">Precio:</h6>
                        <p class="fs-3 mb-2"><strong class="text-neon">${{ p.price }}</strong></p>
                        {% if p.ml %}
                        <p class="mb-0"><strong>Contenido:</strong> {{ p.ml }} ml</p>
                        {% endif %}
                    </div>

                    {% elif category.name.upper() == "COMPLEMENTOS" %}
                    <!-- COMPLEMENTOS: Precio, gramos e ingredientes (solo algunos) -->
                    <div class="mb-3 text-center">
                        <h6 class="text-neon mb-2">Precio:</h6>
                        <p class="fs-3 mb-2"><strong class="text-neon">${{ p.price }}</strong></p>
                        {% if p.grams %}
                        <p class="mb-2"><strong>Peso:</strong> {{ p.grams }} g</p>
                        {% endif %}
                    </div>
                    {% if p.ingredients %}
                    <div class="mb-2">
                        <h6 class="text-neon text-center mb-1">Ingredientes:</h6>
                        <p class="small mb-0 text-center">{{ p.ingredients }}</p>
                    </div>
                    {% endif %}

                    {% else %}
                    <!-- Otras categorías: Precio genérico -->
                    <div class="mb-3 text-center">
                        <h6 class="text-neon mb-2">Precio:</h6>
                        <p class="fs-3 mb-0"><strong class="text-neon">${{ p.price }}</strong></p>
                    </div>
                    {% endif %}
                    
                    <!-- Botón Agregar al Carrito -->
                    {% if mesa_num %}
                    <div class="mt-3 text-center">
                        {% if category.name.upper() == "PIZZAS" %}
                        <!-- Para pizzas: selector de tamaño -->
                        <div class="mb-2">
                            <select class="form-select form-select-sm" id="size_{{ p._id|string }}">
                                {% if p.price_individual %}<option value="individual">Individual - ${{ p.price_individual }}</option>{% endif %}
                                {% if p.price_chica %}<option value="chica">Chica - ${{ p.price_chica }}</option>{% endif %}
                                {% if p.price_mediana %}<option value="mediana">Mediana - ${{ p.price_mediana }}</option>{% endif %}
                                {% if p.price_grande %}<option value="grande">Grande - ${{ p.price_grande }}</option>{% endif %}
                                {% if p.price_h4 %}<option value="h4">H4 - ${{ p.price_h4 }}</option>{% endif %}
                            </select>
                        </div>
                        <!-- Opciones adicionales para pizzas -->
                        <div class="mb-2 text-start small">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="division_{{ p._id|string }}" value="1">
                                <label class="form-check-label text-white" for="division_{{ p._id|string }}">
                                    División (+$10)
                                </label>
                            </div>
                            <!-- Selector de segunda mitad (solo visible cuando división está marcada) -->
                            <div id="second_half_container_{{ p._id|string }}" style="display: none;" class="mb-2">
                                <label class="form-label text-white small">Segunda mitad:</label>
                                <select class="form-select form-select-sm" id="second_half_{{ p._id|string }}">
                                    <option value="">Selecciona otra pizza</option>
                                    {% for pizza in all_pizzas %}
                                    {% if pizza._id|string != p._id|string %}
                                    <option value="{{ pizza._id|string }}" data-name="{{ pizza.name }}">
                                        {{ pizza.name }}
                                    </option>
                                    {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="orilla_queso_{{ p._id|string }}" value="1">
                                <label class="form-check-label text-white" for="orilla_queso_{{ p._id|string }}" id="orilla_queso_label_{{ p._id|string }}">
                                    Orilla de queso
                                </label>
                            </div>
                        </div>
                        {% endif %}
                        <button class="btn btn-success btn-sm add-to-cart-btn" 
                                data-product-id="{{ p._id|string }}"
                                data-product-name="{{ p.name }}"
                                {% if category.name.upper() == "PIZZAS" %}data-has-size="true"{% endif %}>
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 4px;">
                                <path d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.491-.408L2.01 3.607 1.61 2H.5a.5.5 0 0 1-.5-.5zM3.618 4l1.5 7h7.764l1.5-7H3.618zM5 14a1 1 0 1 1 2 0 1 1 0 0 1-2 0zm7 0a1 1 0 1 1 2 0 1 1 0 0 1-2 0z"/>
                            </svg>
                            Agregar
                        </button>
                    </div>
                    {% endif %}
                    
                    <p class="text-center small text-muted mt-auto mb-0" style="font-size: 0.75rem;">Click para ampliar</p>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% if not products %}
<div class="alert alert-info text-center">
    <p class="mb-0">No hay productos disponibles en esta categoría.</p>
</div>
{% endif %}

{% if total_pages|default(1) > 1 %}
<!-- Paginación -->
<nav aria-label="Navegación de páginas" class="mt-4">
    <ul class="pagination justify-content-center pagination-custom">
        {% if (page|default(1)) > 1 %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('show_category', id=category._id|string, page=page-1) }}" aria-label="Anterior">
                <span aria-hidden="true">&laquo; Anterior</span>
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">&laquo; Anterior</span>
        </li>
        {% endif %}

        {% set start_page = [1, (page|default(1)) - 1]|max %}
        {% set end_page = [(total_pages|default(1)), (page|default(1)) + 1]|min %}
        
        {% if start_page > 1 %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('show_category', id=category._id|string, page=1) }}">1</a>
        </li>
        {% if start_page > 2 %}
        <li class="page-item disabled">
            <span class="page-link">...</span>
        </li>
        {% endif %}
        {% endif %}

        {% for p in range(start_page, end_page + 1) %}
            {% if p == (page|default(1)) %}
            <li class="page-item active">
                <span class="page-link">{{ p }}</span>
            </li>
            {% else %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('show_category', id=category._id|string, page=p) }}">{{ p }}</a>
            </li>
            {% endif %}
        {% endfor %}

        {% if end_page < total_pages %}
        {% if end_page < total_pages - 1 %}
        <li class="page-item disabled">
            <span class="page-link">...</span>
        </li>
        {% endif %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('show_category', id=category._id|string, page=total_pages) }}">{{ total_pages }}</a>
        </li>
        {% endif %}

        {% if (page|default(1)) < (total_pages|default(1)) %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('show_category', id=category._id|string, page=page+1) }}" aria-label="Siguiente">
                <span aria-hidden="true">Siguiente &raquo;</span>
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">Siguiente &raquo;</span>
        </li>
        {% endif %}
    </ul>
    <div class="text-center mt-2">
        <small class="text-muted">Página {{ page|default(1) }} de {{ total_pages|default(1) }} ({{ total_products|default(0) }} productos)</small>
    </div>
</nav>
{% endif %}

<style>
.zoom-card-container {
    height: 100%;
    position: relative;
    z-index: 1;
}

.zoom-card {
    position: relative;
    width: 100%;
    height: 100%;
    min-height: 260px;
    transition: transform 0.4s ease, z-index 0.4s;
    cursor: pointer;
    overflow: hidden;
}

.zoom-card.zoomed {
    transform: scale(1.15);
    z-index: 10;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
}

.zoom-card-front {
    width: 100%;
    height: 100%;
    transition: opacity 0.3s ease;
}

.zoom-card-back {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s;
    overflow-y: auto;
    background: inherit;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.zoom-card.zoomed .zoom-card-front {
    opacity: 0;
    visibility: hidden;
}

.zoom-card.zoomed .zoom-card-back {
    opacity: 1;
    visibility: visible;
}

/* Responsive para zoom cards */
@media (max-width: 768px) {
    .zoom-card {
        min-height: 220px;
    }
    
    .zoom-card.zoomed {
        transform: scale(1.2);
    }
}

@media (max-width: 576px) {
    .zoom-card {
        min-height: 200px;
    }
    
    .zoom-card.zoomed {
        transform: scale(1.25);
    }
    
    .zoom-card-back {
        padding: 1rem !important;
    }
    
    .zoom-card-back h5 {
        font-size: 1rem !important;
        margin-bottom: 0.75rem !important;
    }
    
    .zoom-card-back h6 {
        font-size: 0.9rem !important;
    }
    
    .zoom-card-back .fs-3 {
        font-size: 1.5rem !important;
    }
    
    .zoom-card-back ul {
        font-size: 0.8rem;
    }
    
    .zoom-card-back .small {
        font-size: 0.75rem !important;
    }
}

@media (max-width: 400px) {
    .zoom-card {
        min-height: 180px;
    }
    
    .zoom-card.zoomed {
        transform: scale(1.3);
    }
    
    .zoom-card-back {
        padding: 0.75rem !important;
    }
    
    .zoom-card-back h5 {
        font-size: 0.95rem !important;
        margin-bottom: 0.5rem !important;
    }
    
    .zoom-card-back .fs-3 {
        font-size: 1.3rem !important;
    }
}

.add-to-cart-btn {
    width: 100%;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Precios de orilla de queso por tamaño
    const orillaPrices = {
        "individual": 15,
        "chica": 20,
        "mediana": 25,
        "grande": 30,
        "h4": 40
    };
    
    // Mostrar/ocultar selector de segunda mitad cuando se marca división
    document.querySelectorAll('input[id^="division_"]').forEach(checkbox => {
        checkbox.addEventListener('change', function(e) {
            e.stopPropagation();
            const productId = this.id.replace('division_', '');
            const secondHalfContainer = document.getElementById('second_half_container_' + productId);
            const secondHalfSelect = document.getElementById('second_half_' + productId);
            
            if (this.checked) {
                secondHalfContainer.style.display = 'block';
            } else {
                secondHalfContainer.style.display = 'none';
                if (secondHalfSelect) {
                    secondHalfSelect.value = '';
                }
            }
        });
    });
    
    // Actualizar precio de orilla de queso cuando cambia el tamaño
    document.querySelectorAll('select[id^="size_"]').forEach(select => {
        select.addEventListener('change', function(e) {
            e.stopPropagation();
            const productId = this.id.replace('size_', '');
            const selectedSize = this.value;
            const orillaLabel = document.getElementById('orilla_queso_label_' + productId);
            
            if (orillaLabel && selectedSize in orillaPrices) {
                orillaLabel.textContent = `Orilla de queso (+$${orillaPrices[selectedSize]})`;
            }
        });
        
        // Actualizar precio inicial
        const productId = select.id.replace('size_', '');
        const selectedSize = select.value;
        const orillaLabel = document.getElementById('orilla_queso_label_' + productId);
        if (orillaLabel && selectedSize in orillaPrices) {
            orillaLabel.textContent = `Orilla de queso (+$${orillaPrices[selectedSize]})`;
        }
    });
    
    // Prevenir que los elementos interactivos activen el zoom de la card
    document.querySelectorAll('.zoom-card select, .zoom-card input[type="checkbox"], .zoom-card label, .zoom-card button').forEach(element => {
        element.addEventListener('click', function(e) {
            e.stopPropagation(); // Evitar que se active el zoom
        });
        // También prevenir en el evento change para los selects
        if (element.tagName === 'SELECT') {
            element.addEventListener('change', function(e) {
                e.stopPropagation();
            });
        }
    });
    
    document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation(); // Evitar que se active el zoom
            
            const productId = this.getAttribute('data-product-id');
            const hasSize = this.getAttribute('data-has-size') === 'true';
            let size = '';
            
            if (hasSize) {
                const sizeSelect = document.getElementById('size_' + productId);
                if (sizeSelect) {
                    size = sizeSelect.value;
                }
            }
            
            // Obtener opciones de división y orilla de queso para pizzas
            let division = '';
            let orilla_queso = '';
            let second_half_id = '';
            if (hasSize) {
                const divisionCheck = document.getElementById('division_' + productId);
                const orillaQuesoCheck = document.getElementById('orilla_queso_' + productId);
                if (divisionCheck && divisionCheck.checked) {
                    division = '1';
                    // Obtener segunda mitad si está seleccionada
                    const secondHalfSelect = document.getElementById('second_half_' + productId);
                    if (secondHalfSelect && secondHalfSelect.value) {
                        second_half_id = secondHalfSelect.value;
                    }
                }
                if (orillaQuesoCheck && orillaQuesoCheck.checked) {
                    orilla_queso = '1';
                }
            }
            
            // Validar que si hay división, se haya seleccionado segunda mitad
            if (division && !second_half_id) {
                alert('Por favor selecciona la segunda mitad de la pizza para la división.');
                return;
            }
            
            const formData = new FormData();
            formData.append('product_id', productId);
            formData.append('quantity', '1');
            if (size) {
                formData.append('size', size);
            }
            if (division) {
                formData.append('division', division);
                if (second_half_id) {
                    formData.append('second_half_id', second_half_id);
                }
            }
            if (orilla_queso) {
                formData.append('orilla_queso', orilla_queso);
            }
            
            // Deshabilitar botón mientras se procesa
            this.disabled = true;
            const originalText = this.innerHTML;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';
            
            fetch('{{ url_for("add_to_cart") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostrar notificación
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
                    alert.style.zIndex = '9999';
                    alert.innerHTML = `
                        <strong>¡Agregado!</strong> ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(alert);
                    
                    // Actualizar contador del carrito si existe
                    const cartBadge = document.getElementById('cart-badge');
                    if (cartBadge) {
                        cartBadge.textContent = data.cart_count || '';
                    }
                    
                    // Remover alerta después de 3 segundos
                    setTimeout(() => {
                        alert.remove();
                    }, 3000);
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al agregar al carrito. Por favor, intenta de nuevo.');
            })
            .finally(() => {
                this.disabled = false;
                this.innerHTML = originalText;
            });
        });
    });
});
</script>

{% endblock %}
