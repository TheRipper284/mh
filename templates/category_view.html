{% extends "layout.html" %}
{% block content %}

<div class="category-nav d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
    <h2 class="text-white mb-0">{{ category.name }}</h2>

    <div class="dropdown ms-md-auto">
        <button class="btn btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
            Ir a otra categoría
        </button>
        <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end">
            <li><a class="dropdown-item" href="{{ url_for('index') }}">Inicio</a></li>
            <li><hr class="dropdown-divider"></li>
            {% for other in other_categories | default([]) %}
            <li>
                <a class="dropdown-item" href="{{ url_for('show_category', id=other._id|string) }}">
                    {{ other.name }}
                </a>
            </li>
            {% else %}
            <li><span class="dropdown-item-text text-muted">Sin otras categorías</span></li>
            {% endfor %}
        </ul>
    </div>
</div>

<div class="row g-3">
    {% for p in products %}
    <div class="col-4 col-md-4 col-lg-3">
        <div class="flip-card-container">
            <div class="flip-card" onclick="this.classList.toggle('flipped')">
                <!-- Frente de la carta -->
                <div class="flip-card-front card card-category text-white h-100">
                    <div class="card-img-wrap">
                        {% if p.image %}
                        <img src="{{ p.image }}" class="card-img-top" alt="{{ p.name }}">
                        {% else %}
                        <img src="{{ url_for('static', filename='uploads/default.jpg') }}" class="card-img-top" alt="{{ p.name }}">
                        {% endif %}
                    </div>
                    <div class="card-img-overlay d-flex flex-column justify-content-end p-3 overlay-dark">
                        <h5 class="card-title text-white mb-0">{{ p.name }}</h5>
                    </div>
                </div>
                
                <!-- Reverso de la carta -->
                <div class="flip-card-back card card-category text-white h-100 d-flex flex-column justify-content-center p-3">
                    <h5 class="card-title text-center mb-3">{{ p.name }}</h5>
                    
                    {% if category.name.upper() == "PIZZAS" %}
                    <!-- PIZZAS: Precios por tamaño e ingredientes -->
                    <div class="mb-3">
                        <h6 class="text-neon text-center mb-2">Precios por Tamaño:</h6>
                        <ul class="list-unstyled small">
                            {% if p.price_individual %}
                            <li class="mb-1">Individual: <strong class="text-neon">${{ p.price_individual }}</strong></li>
                            {% endif %}
                            {% if p.price_chica %}
                            <li class="mb-1">Chica: <strong class="text-neon">${{ p.price_chica }}</strong></li>
                            {% endif %}
                            {% if p.price_mediana %}
                            <li class="mb-1">Mediana: <strong class="text-neon">${{ p.price_mediana }}</strong></li>
                            {% endif %}
                            {% if p.price_grande %}
                            <li class="mb-1">Grande: <strong class="text-neon">${{ p.price_grande }}</strong></li>
                            {% endif %}
                            {% if p.price_h4 %}
                            <li class="mb-1">H4: <strong class="text-neon">${{ p.price_h4 }}</strong></li>
                            {% endif %}
                        </ul>
                    </div>
                    {% if p.ingredients %}
                    <div class="mb-2">
                        <h6 class="text-neon text-center mb-1">Ingredientes:</h6>
                        <p class="small mb-0 text-center">{{ p.ingredients }}</p>
                    </div>
                    {% endif %}

                    {% elif category.name.upper() == "BEBIDAS" %}
                    <!-- BEBIDAS: Precio y ML -->
                    <div class="mb-3 text-center">
                        <h6 class="text-neon mb-2">Precio:</h6>
                        <p class="fs-3 mb-2"><strong class="text-neon">${{ p.price }}</strong></p>
                        {% if p.ml %}
                        <p class="mb-0"><strong>Contenido:</strong> {{ p.ml }} ml</p>
                        {% endif %}
                    </div>

                    {% elif category.name.upper() == "COMPLEMENTOS" %}
                    <!-- COMPLEMENTOS: Precio, gramos e ingredientes (solo algunos) -->
                    <div class="mb-3 text-center">
                        <h6 class="text-neon mb-2">Precio:</h6>
                        <p class="fs-3 mb-2"><strong class="text-neon">${{ p.price }}</strong></p>
                        {% if p.grams %}
                        <p class="mb-2"><strong>Peso:</strong> {{ p.grams }} g</p>
                        {% endif %}
                    </div>
                    {% if p.ingredients %}
                    <div class="mb-2">
                        <h6 class="text-neon text-center mb-1">Ingredientes:</h6>
                        <p class="small mb-0 text-center">{{ p.ingredients }}</p>
                    </div>
                    {% endif %}

                    {% else %}
                    <!-- Otras categorías: Precio genérico -->
                    <div class="mb-3 text-center">
                        <h6 class="text-neon mb-2">Precio:</h6>
                        <p class="fs-3 mb-0"><strong class="text-neon">${{ p.price }}</strong></p>
                    </div>
                    {% endif %}
                    
                    <!-- Botón Agregar al Carrito -->
                    {% if mesa_num %}
                    <div class="mt-3 text-center">
                        {% if category.name.upper() == "PIZZAS" %}
                        <!-- Para pizzas: selector de tamaño -->
                        <div class="mb-2">
                            <select class="form-select form-select-sm" id="size_{{ p._id|string }}">
                                {% if p.price_individual %}<option value="individual">Individual - ${{ p.price_individual }}</option>{% endif %}
                                {% if p.price_chica %}<option value="chica">Chica - ${{ p.price_chica }}</option>{% endif %}
                                {% if p.price_mediana %}<option value="mediana">Mediana - ${{ p.price_mediana }}</option>{% endif %}
                                {% if p.price_grande %}<option value="grande">Grande - ${{ p.price_grande }}</option>{% endif %}
                                {% if p.price_h4 %}<option value="h4">H4 - ${{ p.price_h4 }}</option>{% endif %}
                            </select>
                        </div>
                        {% endif %}
                        <button class="btn btn-success btn-sm add-to-cart-btn" 
                                data-product-id="{{ p._id|string }}"
                                data-product-name="{{ p.name }}"
                                {% if category.name.upper() == "PIZZAS" %}data-has-size="true"{% endif %}>
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 4px;">
                                <path d="M0 1.5A.5.5 0 0 1 .5 1H2a.5.5 0 0 1 .485.379L2.89 3H14.5a.5.5 0 0 1 .491.592l-1.5 8A.5.5 0 0 1 13 12H4a.5.5 0 0 1-.491-.408L2.01 3.607 1.61 2H.5a.5.5 0 0 1-.5-.5zM3.618 4l1.5 7h7.764l1.5-7H3.618zM5 14a1 1 0 1 1 2 0 1 1 0 0 1-2 0zm7 0a1 1 0 1 1 2 0 1 1 0 0 1-2 0z"/>
                            </svg>
                            Agregar
                        </button>
                    </div>
                    {% endif %}
                    
                    <p class="text-center small text-muted mt-auto mb-0" style="font-size: 0.75rem;">Click para voltear</p>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% if not products %}
<div class="alert alert-info text-center">
    <p class="mb-0">No hay productos disponibles en esta categoría.</p>
</div>
{% endif %}

{% if total_pages|default(1) > 1 %}
<!-- Paginación -->
<nav aria-label="Navegación de páginas" class="mt-4">
    <ul class="pagination justify-content-center pagination-custom">
        {% if (page|default(1)) > 1 %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('show_category', id=category._id|string, page=page-1) }}" aria-label="Anterior">
                <span aria-hidden="true">&laquo; Anterior</span>
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">&laquo; Anterior</span>
        </li>
        {% endif %}

        {% set start_page = [1, (page|default(1)) - 1]|max %}
        {% set end_page = [(total_pages|default(1)), (page|default(1)) + 1]|min %}
        
        {% if start_page > 1 %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('show_category', id=category._id|string, page=1) }}">1</a>
        </li>
        {% if start_page > 2 %}
        <li class="page-item disabled">
            <span class="page-link">...</span>
        </li>
        {% endif %}
        {% endif %}

        {% for p in range(start_page, end_page + 1) %}
            {% if p == (page|default(1)) %}
            <li class="page-item active">
                <span class="page-link">{{ p }}</span>
            </li>
            {% else %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('show_category', id=category._id|string, page=p) }}">{{ p }}</a>
            </li>
            {% endif %}
        {% endfor %}

        {% if end_page < total_pages %}
        {% if end_page < total_pages - 1 %}
        <li class="page-item disabled">
            <span class="page-link">...</span>
        </li>
        {% endif %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('show_category', id=category._id|string, page=total_pages) }}">{{ total_pages }}</a>
        </li>
        {% endif %}

        {% if (page|default(1)) < (total_pages|default(1)) %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('show_category', id=category._id|string, page=page+1) }}" aria-label="Siguiente">
                <span aria-hidden="true">Siguiente &raquo;</span>
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">Siguiente &raquo;</span>
        </li>
        {% endif %}
    </ul>
    <div class="text-center mt-2">
        <small class="text-muted">Página {{ page|default(1) }} de {{ total_pages|default(1) }} ({{ total_products|default(0) }} productos)</small>
    </div>
</nav>
{% endif %}

<style>
.flip-card-container {
    perspective: 1000px;
    height: 100%;
}

.flip-card {
    position: relative;
    width: 100%;
    height: 100%;
    min-height: 260px;
    transform-style: preserve-3d;
    transition: transform 0.6s;
    cursor: pointer;
}

.flip-card.flipped {
    transform: rotateY(180deg);
}

.flip-card-front,
.flip-card-back {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
}

.flip-card-back {
    transform: rotateY(180deg);
    overflow-y: auto;
}

/* Responsive para flip cards */
@media (max-width: 768px) {
    .flip-card {
        min-height: 220px;
    }
}

@media (max-width: 576px) {
    .flip-card {
        min-height: 200px;
    }
    
    .flip-card-back {
        padding: 1rem !important;
    }
    
    .flip-card-back h5 {
        font-size: 1rem !important;
        margin-bottom: 0.75rem !important;
    }
    
    .flip-card-back h6 {
        font-size: 0.9rem !important;
    }
    
    .flip-card-back .fs-3 {
        font-size: 1.5rem !important;
    }
    
    .flip-card-back ul {
        font-size: 0.8rem;
    }
    
    .flip-card-back .small {
        font-size: 0.75rem !important;
    }
}

@media (max-width: 400px) {
    .flip-card {
        min-height: 180px;
    }
    
    .flip-card-back {
        padding: 0.75rem !important;
    }
    
    .flip-card-back h5 {
        font-size: 0.95rem !important;
        margin-bottom: 0.5rem !important;
    }
    
    .flip-card-back .fs-3 {
        font-size: 1.3rem !important;
    }
}

.add-to-cart-btn {
    width: 100%;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation(); // Evitar que se active el flip
            
            const productId = this.getAttribute('data-product-id');
            const hasSize = this.getAttribute('data-has-size') === 'true';
            let size = '';
            
            if (hasSize) {
                const sizeSelect = document.getElementById('size_' + productId);
                if (sizeSelect) {
                    size = sizeSelect.value;
                }
            }
            
            const formData = new FormData();
            formData.append('product_id', productId);
            formData.append('quantity', '1');
            if (size) {
                formData.append('size', size);
            }
            
            // Deshabilitar botón mientras se procesa
            this.disabled = true;
            const originalText = this.innerHTML;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';
            
            fetch('{{ url_for("add_to_cart") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostrar notificación
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
                    alert.style.zIndex = '9999';
                    alert.innerHTML = `
                        <strong>¡Agregado!</strong> ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(alert);
                    
                    // Actualizar contador del carrito si existe
                    const cartBadge = document.getElementById('cart-badge');
                    if (cartBadge) {
                        cartBadge.textContent = data.cart_count || '';
                    }
                    
                    // Remover alerta después de 3 segundos
                    setTimeout(() => {
                        alert.remove();
                    }, 3000);
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al agregar al carrito. Por favor, intenta de nuevo.');
            })
            .finally(() => {
                this.disabled = false;
                this.innerHTML = originalText;
            });
        });
    });
});
</script>

{% endblock %}
